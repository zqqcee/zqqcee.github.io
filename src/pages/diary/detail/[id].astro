---
import HomeLayout from '../../../layouts/HomeLayout.astro';
import BlurFade from '@/components/ui/BlurFadeIn';
import Comments from '@/components/Comments';
import dayjs from 'dayjs';
import { getDiaryById, getAllDiaries } from '@/data/diary';
import type { IDiary, BookMetadata, MovieMetadata, LinkMetadata } from '@/types/diary';
import { DiaryType } from '@/types/diary';

export async function getStaticPaths() {
	const allDiaries = await getAllDiaries();
	return allDiaries.map((diary) => ({
		params: { id: diary.id },
		props: { diary },
	}));
}

interface Props {
	diary: IDiary;
}

const { diary } = Astro.props as Props;
const url = new URL(Astro.url.pathname, Astro.site);

// 渲染星级评分
const renderStars = (rating?: number) => {
	if (!rating) return '';
	return '★'.repeat(rating) + '☆'.repeat(5 - rating);
};
---

<HomeLayout showNeon={true} isPost title={diary.content.slice(0, 30)}>
	<BlurFade client:load className="mx-auto max-w-4xl my-40 px-6 lg:px-20">
		<div class="flex flex-col gap-8 max-w-3xl text-white">
			<!-- 头部 -->
			<div class="flex items-center gap-4">
				<img
					src={diary.avatar}
					alt={diary.author}
					class="w-14 h-14 rounded-full border border-gray-600"
				/>
				<div>
					<div class="font-bold text-lg">{diary.author}</div>
					<div class="text-gray-400 text-sm">
						{dayjs(diary.date).format('YYYY-MM-DD HH:mm')}
					</div>
				</div>
			</div>

			<!-- Metadata 完整展示 -->
			{
				diary.type === DiaryType.BOOK && diary.metadata && (
					<div class="p-6 rounded-lg bg-sky-900/20 border border-sky-700/30">
						<div class="flex gap-6">
							{(diary.metadata as BookMetadata).coverImage && (
								<img
									src={(diary.metadata as BookMetadata).coverImage}
									alt="book cover"
									class="w-32 h-48 object-cover rounded shadow-lg"
								/>
							)}
							<div class="flex-1">
								<div class="text-2xl font-bold text-white mb-2">
									{(diary.metadata as BookMetadata).bookTitle}
								</div>
								<div class="text-gray-300 text-lg mb-3">
									作者: {(diary.metadata as BookMetadata).bookAuthor}
								</div>
								{(diary.metadata as BookMetadata).isbn && (
									<div class="text-gray-400 text-sm mb-2">
										ISBN: {(diary.metadata as BookMetadata).isbn}
									</div>
								)}
								{(diary.metadata as BookMetadata).rating && (
									<div class="text-amber-400 text-xl">
										{renderStars((diary.metadata as BookMetadata).rating)}
									</div>
								)}
							</div>
						</div>
					</div>
				)
			}

			{
				diary.type === DiaryType.MOVIE && diary.metadata && (
					<div class="p-6 rounded-lg bg-purple-900/20 border border-purple-700/30">
						<div class="flex gap-6">
							{(diary.metadata as MovieMetadata).posterImage && (
								<img
									src={(diary.metadata as MovieMetadata).posterImage}
									alt="movie poster"
									class="w-32 h-48 object-cover rounded shadow-lg"
								/>
							)}
							<div class="flex-1">
								<div class="text-2xl font-bold text-white mb-2">
									{(diary.metadata as MovieMetadata).movieTitle}
								</div>
								<div class="text-gray-300 text-lg mb-3">
									导演: {(diary.metadata as MovieMetadata).director}
								</div>
								<div class="flex items-center gap-4">
									{(diary.metadata as MovieMetadata).year && (
										<span class="text-gray-400">
											{(diary.metadata as MovieMetadata).year}
										</span>
									)}
									{(diary.metadata as MovieMetadata).rating && (
										<span class="text-amber-400 text-xl">
											{renderStars((diary.metadata as MovieMetadata).rating)}
										</span>
									)}
								</div>
							</div>
						</div>
					</div>
				)
			}

			{
				diary.type === DiaryType.LINK && diary.metadata && (
					<a
						href={(diary.metadata as LinkMetadata).url}
						target="_blank"
						rel="noopener noreferrer"
						class="p-6 rounded-lg bg-green-900/20 border border-green-700/30 hover:bg-green-900/30 transition-colors block"
					>
						<div class="flex items-start gap-4">
							{(diary.metadata as LinkMetadata).favicon && (
								<img
									src={(diary.metadata as LinkMetadata).favicon}
									alt="favicon"
									class="w-8 h-8 mt-1"
								/>
							)}
							<div class="flex-1">
								<div class="text-xl font-bold text-white mb-2">
									{(diary.metadata as LinkMetadata).linkTitle}
								</div>
								{(diary.metadata as LinkMetadata).linkDescription && (
									<div class="text-gray-300 mb-3">
										{(diary.metadata as LinkMetadata).linkDescription}
									</div>
								)}
								<div class="text-gray-500 text-sm break-all">
									{(diary.metadata as LinkMetadata).url}
								</div>
							</div>
						</div>
					</a>
				)
			}

			<!-- 内容 -->
			<div
				class="prose prose-base leading-loose max-w-full text-gray-100 text-base
        prose-headings:text-white
        prose-a:prose-a:px-1 prose-a:underline-offset-4
        prose-p:text-justify
        prose-img:rounded-xl
        prose-blockquote:not-italic prose-blockquote:text-gray-300
        prose-code:font-mono"
			>
				{diary.content}
			</div>

			<!-- 图片库 -->
			{
				diary.images && diary.images.length > 0 && (
					<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
						{diary.images.map((image) => (
							<img
								src={image}
								alt="diary"
								class="rounded-lg w-full h-auto"
								loading="lazy"
							/>
						))}
					</div>
				)
			}

			<!-- 标签 -->
			{
				diary.tags && diary.tags.length > 0 && (
					<div class="flex flex-wrap gap-2">
						{diary.tags.map((tag) => (
							<span class="px-3 py-1 text-sm rounded-md bg-sky-900/30 text-sky-200 hover:bg-sky-900/50 transition-colors">
								{tag}
							</span>
						))}
					</div>
				)
			}

			<!-- 分隔线 -->
			<div class="bg-gray-500 h-px w-full mt-5"></div>

			<!-- 评论区 -->
			<Comments
				client:load
				pageId={url.toString()}
				pageTitle={diary.content.slice(0, 30)}
			/>
		</div>
	</BlurFade>
</HomeLayout>
